<div class="layui-container" style="margin-top:10px;">
    <div class="layui-row">
        {include file="user/rightmenu" /}
        <div class="layui-col-lg9">
            <script type="text/html" id="toolbarDemo">
                <div class="layui-btn-container">
                    <button class="layui-btn layui-btn-sm" lay-event="addDevice">添加设备</button>
                </div>
            </script>
            <table class="layui-hide" id="deviceList" lay-filter="deviceList"></table>
            <script type="text/html" id="barTool">
                <a class="layui-btn layui-btn-xs" lay-event="view">查看</a>
                <a class="layui-btn layui-btn-xs" lay-event="del">删除</a>
                <a class="layui-btn layui-btn-xs" lay-event="sendMsg">发送消息</a>
            </script>
        </div>
    </div>
</div>
<script>

    layui.use('table', function () {
        var table = layui.table;
        table.render({
            elem: '#deviceList'
            , url: '/api/device/deviceList'
            , toolbar: '#toolbarDemo'
            , title: '设备列表'
            , cols: [[
                {field: 'device_id', title: '设备ID', width: 100, fixed: 'left'}
                , {field: 'device_name', title: '设备名', width: 120}
                , {field: 'desc', title: '简介', width: 150}
                , {field: 'status', title: '状态', width: 80}
                , {field: 'location', title: '设备部署地址', width: 120}
                , {field: 'create_at', title: '创建时间', width: 120}
                , {fixed: 'right', title: '操作', toolbar: '#barTool', width: 200}
            ]]
            , page: true
            , response: {
                statusCode: 1 //重新规定成功的状态码为 1
            }, parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.message, //解析提示文本
                    "count": res.data.total, //解析数据长度
                    "data": res.data.rows //解析数据列表
                };
            }
        });
        //监听行工具事件
        table.on('tool(deviceList)', function (obj) {
            var data = obj.data;
            if (obj.event === 'view') {
                location.href = '/portal/cloud/deviceDetail?device=' + obj.data.device_id;
            }
            if (obj.event === 'del') {
                layer.confirm('确定删除吗？', function (index) {
                    console.log(data);
                    $.ajax({
                        url: '/api/device/deleteDevice', dataType: 'json', type: 'post', data: {
                            'device_id': data.device_id
                        }, success: function (d) {
                            if (d.code == 1) {
                                layer.msg('删除成功！');
                                setTimeout(function () {
                                    location.reload()
                                }, 800);
                            } else {
                                layer.msg(d.message);
                            }
                        }
                    });
                    console.log(obj.data);
                });
            }
            if (obj.event == 'sendMsg') {
                layer.open({
                    type: 2 //此处以iframe举例
                    ,title: '当你选择该窗体时，即会在最顶端'
                    ,area: ['390px', '260px']
                    ,shade: 0
                    ,maxmin: true
                    ,offset:'auto'
                    ,content: '//layer.layui.com/test/settop.html'
                    ,btn: ['继续弹出', '全部关闭'] //只是为了演示
                    ,yes: function(){
                        $(that).click();
                    }
                    ,btn2: function(){
                        layer.closeAll();
                    }

                    ,zIndex: layer.zIndex //重点1
                    ,success: function(layero){
                        layer.setTop(layero); //重点2
                    }
                });
            }
        });

        //头工具栏事件
        table.on('toolbar(deviceList)', function (obj) {
            if ('addDevice' == obj.event) {
                layer.open({
                    type: 2 //此处以iframe举例
                    ,title: '添加设备'
                    ,area: ['800px', '600px']
                    ,shade: 0
                    ,maxmin: true
                    ,offset: 'auto'
                    ,content: '/portal/cloud/adddevice'
                    ,btn: ['关闭']
                    ,btn2: function(){
                      layer.closeAll()
                    }
                    ,zIndex: layer.zIndex //重点1
                    ,success: function(layero){
                        layer.setTop(layero); //重点2
                    }
                });
            }
        });
    });
</script>